<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><title>Macros Spec</title><link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico"></link><script type="text/javascript" src="../../../scripts/clipboard.js" defer="true"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" defer="true"></script><script type="text/javascript" src="../../../scripts/main.js" defer="true"></script><link rel="stylesheet" href="../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../styles/scalastyle.css"></link><link rel="stylesheet" href="../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../styles/diagram.css"></link><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../styles/search-bar.css"></link><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><script type="text/javascript" src="../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../scripts/data.js" defer="true"></script><link rel="stylesheet" href="../../../css/bootstrap.min.css"></link><link rel="stylesheet" href="../../../css/dottydoc.css"></link><link rel="stylesheet" href="../../../css/color-brewer.css"></link><script type="text/javascript" src="../../../js/jquery.min.js" defer="true"></script><script type="text/javascript" src="../../../js/bootstrap.min.js" defer="true"></script><script>var pathToRoot = "../../../";</script></head><body><div id="container"><div id="leftColumn"><div id="logo"><span><img src="../../../project-logo/logo.svg"></img></span><span><div class="projectName">Scala 3</div></span><span><div class="projectVersion">3.0.0-RC1-bin-20210103-e721c66-NIGHTLY</div></span></div><div id="paneSearch"></div><nav id="sideMenu2"><div class="expanded"><a href="../../../index.html">Scala 3</a><span></span><div><a href="../../../blog/index.html">Blog</a><span></span><div><a href="../../../blog/2020/12/18/scala3-m3.html">Scala 3.0.0-M3: developer&apos;s preview before RC1</a></div><div><a href="../../../blog/2020/11/09/scala3-m1.html">Scala 3.0.0-M1 is here</a></div><div><a href="../../../blog/2020/09/21/naming-schema-change.html">Dotty becomes Scala 3</a></div><div><a href="../../../blog/2020/08/31/27th-dotty-milestone-release.html">Announcing Dotty 0.27.0-RC1 - ScalaJS, performance, stability</a></div><div><a href="../../../blog/2020/07/27/26th-dotty-milestone-release.html">Announcing Dotty 0.26.0-RC1 - unified extension methods and more</a></div><div><a href="../../../blog/2020/06/22/25th-dotty-milestone-release.html">Announcing Dotty 0.25.0-RC2 - speed-up of givens and change in the tuple API</a></div><div><a href="../../../blog/2020/04/29/24th-dotty-milestone-release.html">Announcing Dotty 0.24.0-RC1 - 2.13.2 standard library, better error messages and more</a></div><div><a href="../../../blog/2020/03/18/23rd-dotty-milestone-release.html">Announcing Dotty 0.23.0-RC1 - safe initialization checks, type-level bitwise operations and more</a></div><div><a href="../../../blog/2020/02/05/22nd-dotty-milestone-release.html">Announcing Dotty 0.22.0-RC1 - syntactic enhancements, type-level arithmetic and more</a></div><div><a href="../../../blog/2019/12/20/21th-dotty-milestone-release.html">Announcing Dotty 0.21.0-RC1 - explicit nulls, new syntax for `match` and conditional givens, and more</a></div><div><a href="../../../blog/2019/11/04/20th-dotty-milestone-release.html">Announcing Dotty 0.20.0-RC1 – `with` starting indentation blocks, inline given specializations and more</a></div><div><a href="../../../blog/2019/09/23/19th-dotty-milestone-release.html">Announcing Dotty 0.19.0-RC1 – further refinements of the syntax and the migration to 2.13.1 standard library</a></div><div><a href="../../../blog/2019/08/30/18th-dotty-milestone-release.html">Announcing Dotty 0.18.1-RC1 – switch to the 2.13 standard library, indentation-based syntax and other experiments</a></div><div><a href="../../../blog/2019/07/25/17th-dotty-milestone-release.html">Announcing Dotty 0.17.0-RC1 – new implicit scoping rules and more</a></div><div><a href="../../../blog/2019/06/11/16th-dotty-milestone-release.html">Announcing Dotty 0.16.0-RC3 – the Scala Days 2019 Release</a></div><div><a href="../../../blog/2019/05/23/15th-dotty-milestone-release.html">Announcing Dotty 0.15.0-RC1 – the fully bootstrapped compiler</a></div><div><a href="../../../blog/2019/04/15/14th-dotty-milestone-release.html">Announcing Dotty 0.14.0-RC1 with export, immutable arrays, creator applications and more</a></div><div><a href="../../../blog/2019/03/05/13th-dotty-milestone-release.html">Announcing Dotty 0.13.0-RC1 with Spark support, top level definitions and redesigned implicits</a></div><div><a href="../../../blog/2019/01/21/12th-dotty-milestone-release.html">Announcing Dotty 0.12.0-RC1</a></div><div><a href="../../../blog/2018/11/30/11th-dotty-milestone-release.html">Announcing Dotty 0.11.0-RC1</a></div><div><a href="../../../blog/2018/10/10/10th-dotty-milestone-release.html">Announcing Dotty 0.10.0-RC1</a></div><div><a href="../../../blog/2018/07/06/ninth-dotty-milestone-release.html">Announcing Dotty 0.9.0-RC1</a></div><div><a href="../../../blog/2018/04/27/eighth-dotty-milestone-release.html">Announcing Dotty 0.7.0 and 0.8.0-RC1</a></div><div><a href="../../../blog/2018/03/05/seventh-dotty-milestone-release.html">Announcing Dotty 0.6.0 and 0.7.0-RC1</a></div><div><a href="../../../blog/2017/12/01/fifth-dotty-milestone-release.html">Announcing Dotty 0.5.0-RC1</a></div><div><a href="../../../blog/2017/10/16/fourth-dotty-milestone-release.html">Announcing Dotty 0.4.0-RC1</a></div><div><a href="../../../blog/2017/09/07/third-dotty-milestone-release.html">Announcing Dotty 0.3.0-RC2</a></div><div><a href="../../../blog/2017/07/12/second-dotty-milestone-release.html">Announcing Dotty 0.2.0-RC1, with new optimizations, improved stability and IDE support</a></div><div><a href="../../../blog/2017/05/31/first-dotty-milestone-release.html">Announcing Dotty 0.1.2-RC1, a major step towards Scala 3</a></div><div><a href="../../../blog/2016/12/05/implicit-function-types.html">Implicit Function Types</a></div><div><a href="../../../blog/2016/05/05/multiversal-equality.html">Multiversal Equality for Scala</a></div><div><a href="../../../blog/2016/02/17/scaling-dot-soundness.html">Scaling DOT to Scala - Soundness</a></div><div><a href="../../../blog/2016/02/03/essence-of-scala.html">The Essence of Scala</a></div><div><a href="../../../blog/2016/01/02/new-year-resolutions.html">New Year Resolutions</a></div><div><a href="../../../blog/2015/10/23/dotty-compiler-bootstraps.html">We got liftoff!</a></div></div><div><a href="../../Usage/index.html">Usage</a><span></span><div><a href="../../usage/getting-started.html">Getting Started: Users</a></div><div><a href="../../usage/sbt-projects.html">Using Dotty with sbt</a></div><div><a href="../../usage/ide-support.html">IDE support for Dotty</a></div><div><a href="../../usage/worksheet-mode.html">Worksheet mode with Dotty IDE</a></div><div><a href="../../usage/language-versions.html">Language Versions</a></div><div><a href="../../usage/cbt-projects.html">Using Dotty with cbt</a></div><div><a href="../../usage/scala3doc/index.html">Scala3doc</a><span></span><div><a href="../../usage/scala3doc/blog.html">Built-in blog</a></div><div><a href="../../usage/scala3doc/specificTags.html">Scala3doc-specific Tags and Features</a></div><div><a href="../../usage/scala3doc/staticSite.html">Static documentation</a></div><div><a href="../../usage/scala3doc/docComments.html">API Documentation</a></div></div><div><a href="../../usage/dottydoc.html">Dottydoc [Legacy]</a></div></div><div><a href="../../Reference/index.html">Reference</a><span></span><div><a href="../overview.html">Overview</a></div><div><a href="../../New Types/index.html">New Types</a><span></span><div><a href="../new-types/intersection-types.html">Intersection Types</a></div><div><a href="../new-types/union-types.html">Union Types</a></div><div><a href="../new-types/type-lambdas.html">Type Lambdas</a></div><div><a href="../new-types/match-types.html">Match Types</a></div><div><a href="../new-types/dependent-function-types.html">Dependent Function Types</a></div><div><a href="../new-types/polymorphic-function-types.html">Polymorphic Function Types</a></div></div><div><a href="../../Enums/index.html">Enums</a><span></span><div><a href="../enums/enums.html">Enumerations</a></div><div><a href="../enums/adts.html">Algebraic Data Types</a></div><div><a href="../enums/desugarEnums.html">Translation of Enums and ADTs</a></div></div><div><a href="../../Contextual Abstractions/index.html">Contextual Abstractions</a><span></span><div><a href="../contextual/motivation.html">Overview</a></div><div><a href="../contextual/givens.html">Given Instances</a></div><div><a href="../contextual/using-clauses.html">Using Clauses</a></div><div><a href="../contextual/context-bounds.html">Context Bounds</a></div><div><a href="../contextual/given-imports.html">Importing Givens</a></div><div><a href="../contextual/extension-methods.html">Extension Methods</a></div><div><a href="../contextual/type-classes.html">Implementing Type classes</a></div><div><a href="../contextual/derivation.html">Type Class Derivation</a></div><div><a href="../contextual/multiversal-equality.html">Multiversal Equality</a></div><div><a href="../contextual/context-functions.html">Context Functions</a></div><div><a href="../contextual/conversions.html">Implicit Conversions</a></div><div><a href="../contextual/by-name-context-parameters.html">By-Name Context Parameters</a></div><div><a href="../contextual/relationship-implicits.html">Relationship with Scala 2 Implicits</a></div></div><div><a href="../../Metaprogramming/index.html">Metaprogramming</a><span></span><div><a href="toc.html">Overview</a></div><div><a href="inline.html">Inline</a></div><div><a href="macros.html">Macros</a></div><div><a href="staging.html">Multi-Stage Programming</a></div><div><a href="tasty-reflect.html">TASTy Reflect</a></div><div><a href="tasty-inspect.html">TASTy Inspection</a></div></div><div><a href="../../Other New Features/index.html">Other New Features</a><span></span><div><a href="../other-new-features/trait-parameters.html">Trait Parameters</a></div><div><a href="../other-new-features/transparent-traits.html">Transparent Traits</a></div><div><a href="../other-new-features/creator-applications.html">Universal Apply Methods</a></div><div><a href="../other-new-features/export.html">Export Clauses</a></div><div><a href="../other-new-features/opaques.html">Opaque Type Aliases</a></div><div><a href="../other-new-features/open-classes.html">Open Classes</a></div><div><a href="../other-new-features/parameter-untupling.html">Parameter Untupling</a></div><div><a href="../other-new-features/kind-polymorphism.html">Kind Polymorphism</a></div><div><a href="../other-new-features/matchable.html">The Matchable Trait</a></div><div><a href="../other-new-features/threadUnsafe-annotation.html">threadUnsafe annotation</a></div><div><a href="../other-new-features/targetName.html">The @targetName annotation</a></div><div><a href="../other-new-features/control-syntax.html">New Control Syntax</a></div><div><a href="../other-new-features/indentation.html">Optional Braces</a></div><div><a href="../other-new-features/explicit-nulls.html">Explicit Nulls</a></div><div><a href="../other-new-features/safe-initialization.html">Safe Initialization</a></div></div><div><a href="../../Other Changed Features/index.html">Other Changed Features</a><span></span><div><a href="../changed-features/numeric-literals.html">Numeric Literals</a></div><div><a href="../changed-features/structural-types.html">Programmatic Structural Types</a></div><div><a href="../changed-features/operators.html">Rules for Operators</a></div><div><a href="../changed-features/wildcards.html">Wildcard Arguments in Types</a></div><div><a href="../changed-features/type-checking.html">Changes in Type Checking</a></div><div><a href="../changed-features/type-inference.html">Changes in Type Inference</a></div><div><a href="../changed-features/implicit-resolution.html">Changes in Implicit Resolution</a></div><div><a href="../changed-features/implicit-conversions.html">Implicit Conversions</a></div><div><a href="../changed-features/overload-resolution.html">Changes in Overload Resolution</a></div><div><a href="../changed-features/match-syntax.html">Match Expressions</a></div><div><a href="../changed-features/vararg-patterns.html">Vararg Patterns</a></div><div><a href="../changed-features/pattern-bindings.html">Pattern Bindings</a></div><div><a href="../changed-features/pattern-matching.html">Option-less pattern matching</a></div><div><a href="../changed-features/eta-expansion.html">Automatic Eta Expansion</a></div><div><a href="../changed-features/compiler-plugins.html">Changes in Compiler Plugins</a></div><div><a href="../changed-features/lazy-vals-init.html">Lazy Vals initialization</a></div><div><a href="../changed-features/main-functions.html">Main Methods</a></div></div><div><a href="../../Dropped Features/index.html">Dropped Features</a><span></span><div><a href="../dropped-features/delayed-init.html">Dropped: Delayedinit</a></div><div><a href="../dropped-features/macros.html">Dropped: Scala 2 Macros</a></div><div><a href="../dropped-features/existential-types.html">Dropped: Existential Types</a></div><div><a href="../dropped-features/type-projection.html">Dropped: General Type Projection</a></div><div><a href="../dropped-features/do-while.html">Dropped: Do-While</a></div><div><a href="../dropped-features/procedure-syntax.html">Dropped: Procedure Syntax</a></div><div><a href="../dropped-features/package-objects.html">Dropped: Package Objects</a></div><div><a href="../dropped-features/early-initializers.html">Dropped: Early Initializers</a></div><div><a href="../dropped-features/class-shadowing.html">Dropped: Class Shadowing</a></div><div><a href="../dropped-features/limit22.html">Dropped: Limit 22</a></div><div><a href="../dropped-features/xml.html">Dropped: XML Literals</a></div><div><a href="../dropped-features/symlits.html">Dropped: Symbol Literals</a></div><div><a href="../dropped-features/auto-apply.html">Dropped: Auto-Application</a></div><div><a href="../dropped-features/weak-conformance.html">Dropped: Weak Conformance</a></div><div><a href="../dropped-features/nonlocal-returns.html">Deprecated: Nonlocal Returns</a></div><div><a href="../dropped-features/this-qualifier.html">Dropped: private[this] and protected[this]</a></div></div><div><a href="../syntax.html">Scala 3 Syntax Summary</a></div></div><div><a href="../../Contributing/index.html">Contributing</a><span></span><div><a href="../../contributing/contribute-knowledge.html">Contributing Knowledge</a></div><div><a href="../../contributing/getting-started.html">Getting Started</a></div><div><a href="../../contributing/workflow.html">Workflow</a></div><div><a href="../../contributing/testing.html">Testing in Dotty</a></div><div><a href="../../contributing/debugging.html">Debugging Techniques</a></div><div><a href="../../IDEs and Tools/index.html">IDEs and Tools</a><span></span><div><a href="../../contributing/tools/mill.html">Basic Operations with Mill</a></div><div><a href="../../contributing/tools/scalafix.html">Working with Scalafix</a></div></div><div><a href="../../Procedures/index.html">Procedures</a><span></span><div><a href="../../contributing/procedures/release.html">Release Procedure</a></div><div><a href="../../contributing/procedures/vulpix.html">Test Vulpix Framework</a></div></div></div><div><a href="../../Internals/index.html">Internals</a><span></span><div><a href="../../internals/backend.html">Backend Internals</a></div><div><a href="../../internals/classpaths.html">Classpaths</a></div><div><a href="../../internals/core-data-structures.html">Core Data Structures</a></div><div><a href="../../internals/contexts.html">Contexts</a></div><div><a href="../../internals/dotc-scalac.html">Differences between Scalac and Dotty</a></div><div><a href="../../internals/higher-kinded-v2.html">Higher-Kinded Types in Dotty</a></div><div><a href="../../internals/overall-structure.html">Dotty Overall Structure</a></div><div><a href="../../internals/periods.html">Dotc&apos;s concept of time</a></div><div><a href="../../internals/syntax.html">Scala 3 Syntax Summary</a></div><div><a href="../../internals/type-system.html">Type System</a></div><div><a href="../../internals/dotty-internals-1-notes.html">Dotty Internals 1: Trees &amp; Symbols (Meeting Notes)</a></div><div><a href="../../internals/debug-macros.html">Debug Macros</a></div></div><div><a href="../../Resources/index.html">Resources</a><span></span><div><a href="../../resources/talks.html">Talks</a></div></div><div><a href="../../../api/index.html">API</a><span></span><div><a href="../../../api/dotty/tools/tasty.html">dotty.tools.tasty</a></div><div><a href="../../../api/dotty/tools/tasty/util.html">dotty.tools.tasty.util</a></div><div><a href="../../../api/scala.html">scala</a></div><div><a href="../../../api/scala/annotation.html">scala.annotation</a></div><div><a href="../../../api/scala/annotation/meta.html">scala.annotation.meta</a></div><div><a href="../../../api/scala/annotation/unchecked.html">scala.annotation.unchecked</a></div><div><a href="../../../api/scala/beans.html">scala.beans</a></div><div><a href="../../../api/scala/collection.html">scala.collection</a></div><div><a href="../../../api/scala/collection/concurrent.html">scala.collection.concurrent</a></div><div><a href="../../../api/scala/collection/convert.html">scala.collection.convert</a></div><div><a href="../../../api/scala/collection/generic.html">scala.collection.generic</a></div><div><a href="../../../api/scala/collection/immutable.html">scala.collection.immutable</a></div><div><a href="../../../api/scala/collection/mutable.html">scala.collection.mutable</a></div><div><a href="../../../api/scala/compat.html">scala.compat</a></div><div><a href="../../../api/scala/compiletime.html">scala.compiletime</a></div><div><a href="../../../api/scala/compiletime/ops.html">scala.compiletime.ops</a></div><div><a href="../../../api/scala/compiletime/testing.html">scala.compiletime.testing</a></div><div><a href="../../../api/scala/concurrent.html">scala.concurrent</a></div><div><a href="../../../api/scala/concurrent/duration.html">scala.concurrent.duration</a></div><div><a href="../../../api/scala/deriving.html">scala.deriving</a></div><div><a href="../../../api/scala/io.html">scala.io</a></div><div><a href="../../../api/scala/jdk.html">scala.jdk</a></div><div><a href="../../../api/scala/jdk/javaapi.html">scala.jdk.javaapi</a></div><div><a href="../../../api/scala/math.html">scala.math</a></div><div><a href="../../../api/scala/quoted.html">scala.quoted</a></div><div><a href="../../../api/scala/quoted/runtime.html">scala.quoted.runtime</a></div><div><a href="../../../api/scala/ref.html">scala.ref</a></div><div><a href="../../../api/scala/reflect.html">scala.reflect</a></div><div><a href="../../../api/scala/reflect/macros.html">scala.reflect.macros</a></div><div><a href="../../../api/scala/runtime.html">scala.runtime</a></div><div><a href="../../../api/scala/runtime/java8.html">scala.runtime.java8</a></div><div><a href="../../../api/scala/sys.html">scala.sys</a></div><div><a href="../../../api/scala/sys/process.html">scala.sys.process</a></div><div><a href="../../../api/scala/util.html">scala.util</a></div><div><a href="../../../api/scala/util/control.html">scala.util.control</a></div><div><a href="../../../api/scala/util/hashing.html">scala.util.hashing</a></div><div><a href="../../../api/scala/util/matching.html">scala.util.matching</a></div></div></div></nav></div><div id="main"><div id="leftToggler"><span class="icon-toggler"></span></div><div id="searchBar"></div><main>
  <div id="content" pageIds="docs.reference.metaprogramming.macros-spec.md////PointingToDeclaration//-1734077091">
    <div class="breadcrumbs"><a href="../../index.html">Scala 3</a>/<a href="">Macros Spec</a></div>
<html>
 <head>
  <link rel="dns-prefetch" href="//fonts.googleapis.com"> 
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"> 
 </head>
 <body>
  <div id="content-wrapper"> 
   <main class="container"> 
    <header> 
     <h1>Macros Spec</h1> 
     <div class="byline"> <a href="https://github.com/lampepfl/dotty/edit/master/docs/docs/reference/metaprogramming/macros-spec.md"> <i class="far fa-edit"></i> Edit this page on GitHub </a> 
     </div> 
    </header> 
    <h2><a href="#implementation" id="implementation" class="anchor"></a>Implementation</h2> 
    <h3><a href="#syntax" id="syntax" class="anchor"></a>Syntax</h3> 
    <p>Compared to the <a href="../syntax.html">Scala 3 reference grammar</a> there are the following syntax changes:</p> 
    <pre><code>SimpleExpr      ::=  ...
                  |  ‘'’ ‘{’ Block ‘}’
                  |  ‘'’ ‘[’ Type ‘]’
                  |  ‘$’ ‘{’ Block ‘}’
SimpleType      ::=  ...
                  |  ‘$’ ‘{’ Block ‘}’
</code></pre> 
    <p>In addition, an identifier <code>$x</code> starting with a <code>$</code> that appears inside a quoted expression or type is treated as a splice <code>${x}</code> and a quoted identifier <code>'x</code> that appears inside a splice is treated as a quote <code>'{x}</code></p> 
    <h3><a href="#implementation-in-scalac" id="implementation-in-scalac" class="anchor"></a>Implementation in <code>scalac</code></h3> 
    <p>Quotes and splices are primitive forms in the generated abstract syntax trees. Top-level splices are eliminated during macro expansion while typing. On the other hand, top-level quotes are eliminated in an expansion phase <code>PickleQuotes</code> phase (after typing and pickling). PCP checking occurs while preparing the RHS of an inline method for top-level splices and in the <code>Staging</code> phase (after typing and before pickling).</p> 
    <p>Macro-expansion works outside-in. If the outermost scope is a splice, the spliced AST will be evaluated in an interpreter. A call to a previously compiled method can be implemented as a reflective call to that method. With the restrictions on splices that are currently in place that’s all that’s needed. We might allow more interpretation in splices in the future, which would allow us to loosen the restriction. Quotes in spliced, interpreted code are kept as they are, after splices nested in the quotes are expanded.</p> 
    <p>If the outermost scope is a quote, we need to generate code that constructs the quoted tree at run-time. We implement this by serializing the tree as a TASTy structure, which is stored in a string literal. At runtime, an unpickler method is called to deserialize the string into a tree.</p> 
    <p>Splices inside quoted code insert the spliced tree as is, after expanding any quotes in the spliced code recursively.</p> 
    <h2><a href="#formalization" id="formalization" class="anchor"></a>Formalization</h2> 
    <p>The phase consistency principle can be formalized in a calculus that extends simply-typed lambda calculus with quotes and splices.</p> 
    <h3><a href="#syntax-1" id="syntax-1" class="anchor"></a>Syntax</h3> 
    <p>The syntax of terms, values, and types is given as follows:</p> 
    <pre><code>Terms         t  ::=  x                 variable
                      (x: T) =&gt; t       lambda
                      t t               application
                      't                quote
                      $t                splice

Values        v  ::=  (x: T) =&gt; t       lambda
                      'u                quote

Simple terms  u  ::=  x  |  (x: T) =&gt; u  |  u u  |  't

Types         T  ::=  A                 base type
                      T -&gt; T            function type
                      expr T            quoted
</code></pre> 
    <p>Typing rules are formulated using a stack of environments <code>Es</code>. Individual environments <code>E</code> consist as usual of variable bindings <code>x: T</code>. Environments can be combined using the two combinators <code>'</code> and <code>$</code>.</p> 
    <pre><code>Environment   E  ::=  ()                empty
                      E, x: T

Env. stack    Es ::=  ()                empty
                      E                 simple
                      Es * Es           combined

Separator     *  ::=  '
                      $
</code></pre> 
    <p>The two environment combinators are both associative with left and right identity <code>()</code>.</p> 
    <h3><a href="#operational-semantics" id="operational-semantics" class="anchor"></a>Operational semantics:</h3> 
    <p>We define a small step reduction relation <code>--&gt;</code> with the following rules:</p> 
    <pre><code>          ((x: T) =&gt; t) v  --&gt;  [x := v]t

                    ${'u}  --&gt;  u

                       t1  --&gt;  t2
                    -----------------
                    e[t1]  --&gt;  e[t2]
</code></pre> 
    <p>The first rule is standard call-by-value beta-reduction. The second rule says that splice and quotes cancel each other out. The third rule is a context rule; it says that reduction is allowed in the hole <code>[ ]</code> position of an evaluation context. Evaluation contexts <code>e</code> and splice evaluation context <code>e_s</code> are defined syntactically as follows:</p> 
    <pre><code>Eval context    e    ::=  [ ]  |  e t  |  v e  |  'e_s[${e}]
Splice context  e_s  ::=  [ ]  |  (x: T) =&gt; e_s  |  e_s t  |  u e_s
</code></pre> 
    <h3><a href="#typing-rules" id="typing-rules" class="anchor"></a>Typing rules</h3> 
    <p>Typing judgments are of the form <code>Es |- t: T</code>. There are two substructural rules which express the fact that quotes and splices cancel each other out:</p> 
    <pre><code>                    Es1 * Es2 |- t: T
               ---------------------------
               Es1 $ E1 ' E2 * Es2 |- t: T


                    Es1 * Es2 |- t: T
               ---------------------------
               Es1 ' E1 $ E2 * Es2 |- t: T
</code></pre> 
    <p>The lambda calculus fragment of the rules is standard, except that we use a stack of environments. The rules only interact with the topmost environment of the stack.</p> 
    <pre><code>                          x: T in E
                        --------------
                        Es * E |- x: T


                    Es * E, x: T1 |- t: T2
                -------------------------------
                Es * E |- (x: T1) =&gt; t: T -&gt; T2


               Es |- t1: T2 -&gt; T    Es |- t2: T2
               ---------------------------------
                      Es |- t1 t2: T
</code></pre> 
    <p>The rules for quotes and splices map between <code>expr T</code> and <code>T</code> by trading <code>'</code> and <code>$</code> between environments and terms.</p> 
    <pre><code>                     Es $ () |- t: expr T
                     --------------------
                         Es |- $t: T


                       Es ' () |- t: T
                       ----------------
                       Es |- 't: expr T
</code></pre> 
    <p>The meta theory of a slightly simplified 2-stage variant of this calculus is studied <a href="simple-smp.html">separately</a>.</p> 
    <h2><a href="#going-further" id="going-further" class="anchor"></a>Going Further</h2> 
    <p>The metaprogramming framework as presented and currently implemented is quite restrictive in that it does not allow for the inspection of quoted expressions and types. It’s possible to work around this by providing all necessary information as normal, unquoted inline parameters. But we would gain more flexibility by allowing for the inspection of quoted code with pattern matching. This opens new possibilities.</p> 
    <p>For instance, here is a version of <code>power</code> that generates the multiplications directly if the exponent is statically known and falls back to the dynamic implementation of <code>power</code> otherwise.</p> 
    <pre><code class="language-scala">import scala.quoted._

inline def power(x: Double, n: Int): Double =
   ${ powerExpr('x, 'n) }

private def powerExpr(x: Expr[Double], n: Expr[Int])
                     (using Quotes): Expr[Double] =
   n.value match
      case Some(m) =&gt; powerExpr(x, m)
      case _ =&gt; '{ dynamicPower($x, $n) }

private def powerExpr(x: Expr[Double], n: Int)
                     (using Quotes): Expr[Double] =
   if n == 0 then '{ 1.0 }
   else if n == 1 then x
   else if n % 2 == 0 then '{ val y = $x * $x; ${ powerExpr('y, n / 2) } }
   else '{ $x * ${ powerExpr(x, n - 1) } }

private def dynamicPower(x: Double, n: Int): Double =
   if n == 0 then 1.0
   else if n % 2 == 0 then dynamicPower(x * x, n / 2)
   else x * dynamicPower(x, n - 1)
</code></pre> 
    <p>In the above, the method <code>.value</code> maps a constant expression of the type <code>Expr[T]</code> to its value of the type <code>T</code>.</p> 
    <p>With the right extractors, the "AsFunction" conversion that maps expressions over functions to functions over expressions can be implemented in user code:</p> 
    <pre><code class="language-scala">given AsFunction1[T, U]: Conversion[Expr[T =&gt; U], Expr[T] =&gt; Expr[U]] with
   def apply(f: Expr[T =&gt; U]): Expr[T] =&gt; Expr[U] =
      (x: Expr[T]) =&gt; f match
         case Lambda(g) =&gt; g(x)
         case _ =&gt; '{ ($f)($x) }
</code></pre> 
    <p>This assumes an extractor</p> 
    <pre><code class="language-scala">object Lambda:
   def unapply[T, U](x: Expr[T =&gt; U]): Option[Expr[T] =&gt; Expr[U]]
</code></pre> 
    <p>Once we allow inspection of code via extractors, it’s tempting to also add constructors that create typed trees directly without going through quotes. Most likely, those constructors would work over <code>Expr</code> types which lack a known type argument. For instance, an <code>Apply</code> constructor could be typed as follows:</p> 
    <pre><code class="language-scala">def Apply(fn: Expr[Any], args: List[Expr[Any]]): Expr[Any]
</code></pre> 
    <p>This would allow constructing applications from lists of arguments without having to match the arguments one-by-one with the corresponding formal parameter types of the function. We then need "at the end" a method to convert an <code>Expr[Any]</code> to an <code>Expr[T]</code> where <code>T</code> is given from the outside. For instance, if <code>code</code> yields a <code>Expr[Any]</code>, then <code>code.atType[T]</code> yields an <code>Expr[T]</code>. The <code>atType</code> method has to be implemented as a primitive; it would check that the computed type structure of <code>Expr</code> is a subtype of the type structure representing <code>T</code>.</p> 
    <p>Before going down that route, we should evaluate in detail the tradeoffs it presents. Constructing trees that are only verified <em>a posteriori</em> to be type correct loses a lot of guidance for constructing the right trees. So we should wait with this addition until we have more use-cases that help us decide whether the loss in type-safety is worth the gain in flexibility. In this context, it seems that deconstructing types is less error-prone than deconstructing terms, so one might also envisage a solution that allows the former but not the latter.</p> 
    <h2><a href="#conclusion" id="conclusion" class="anchor"></a>Conclusion</h2> 
    <p>Metaprogramming has a reputation of being difficult and confusing. But with explicit <code>Expr/Type</code> types and quotes and splices it can become downright pleasant. A simple strategy first defines the underlying quoted or unquoted values using <code>Expr</code> and <code>Type</code> and then inserts quotes and splices to make the types line up. Phase consistency is at the same time a great guideline where to insert a splice or a quote and a vital sanity check that the result makes sense.</p> 
   </main> 
  </div> 
  <script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'lampepfl/dotty'
  };
</script> 
  <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
 </body>
</html>  </div>
</main><footer><span class="go-to-top-icon"><a href="#container"><span class="icon-vertical_align_top"></span>&nbsp;Back to top</a></span>Generated by&nbsp;<a href="https://github.com/lampepfl/dotty/tree/master/scala3doc"><img src="../../../images/scala3doc_logo.svg" alt="Scala3doc" class="scala3doc_logo"></img></a></footer></div></div><script type="text/javascript" src="../../../scripts/pages.js"></script><script type="text/javascript" src="../../../scripts/main.js"></script></body></html>
