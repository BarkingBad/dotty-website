<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><title>Type Class Derivation</title><link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico"></link><script type="text/javascript" src="../../../scripts/clipboard.js" defer="true"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" defer="true"></script><script type="text/javascript" src="../../../scripts/main.js" defer="true"></script><link rel="stylesheet" href="../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../styles/scalastyle.css"></link><link rel="stylesheet" href="../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../styles/diagram.css"></link><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../styles/search-bar.css"></link><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><script type="text/javascript" src="../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../scripts/data.js" defer="true"></script><link rel="stylesheet" href="../../../css/bootstrap.min.css"></link><link rel="stylesheet" href="../../../css/dottydoc.css"></link><link rel="stylesheet" href="../../../css/color-brewer.css"></link><script type="text/javascript" src="../../../js/jquery.min.js" defer="true"></script><script type="text/javascript" src="../../../js/bootstrap.min.js" defer="true"></script><script>var pathToRoot = "../../../";</script></head><body><div id="container"><div id="leftColumn"><div id="logo"><span><img src="../../../project-logo/logo.svg"></img></span><span><div class="projectName">Scala 3</div></span><span><div class="projectVersion">3.0.0-RC1-bin-20210111-0f1d350-NIGHTLY</div></span></div><div id="paneSearch"></div><nav id="sideMenu2"><div class="expanded"><a href="../../../index.html">Scala 3</a><span></span><div><a href="../../../blog/index.html">Blog</a><span></span><div><a href="../../../blog/2020/12/18/scala3-m3.html">Scala 3.0.0-M3: developer&apos;s preview before RC1</a></div><div><a href="../../../blog/2020/11/09/scala3-m1.html">Scala 3.0.0-M1 is here</a></div><div><a href="../../../blog/2020/09/21/naming-schema-change.html">Dotty becomes Scala 3</a></div><div><a href="../../../blog/2020/08/31/27th-dotty-milestone-release.html">Announcing Dotty 0.27.0-RC1 - ScalaJS, performance, stability</a></div><div><a href="../../../blog/2020/07/27/26th-dotty-milestone-release.html">Announcing Dotty 0.26.0-RC1 - unified extension methods and more</a></div><div><a href="../../../blog/2020/06/22/25th-dotty-milestone-release.html">Announcing Dotty 0.25.0-RC2 - speed-up of givens and change in the tuple API</a></div><div><a href="../../../blog/2020/04/29/24th-dotty-milestone-release.html">Announcing Dotty 0.24.0-RC1 - 2.13.2 standard library, better error messages and more</a></div><div><a href="../../../blog/2020/03/18/23rd-dotty-milestone-release.html">Announcing Dotty 0.23.0-RC1 - safe initialization checks, type-level bitwise operations and more</a></div><div><a href="../../../blog/2020/02/05/22nd-dotty-milestone-release.html">Announcing Dotty 0.22.0-RC1 - syntactic enhancements, type-level arithmetic and more</a></div><div><a href="../../../blog/2019/12/20/21th-dotty-milestone-release.html">Announcing Dotty 0.21.0-RC1 - explicit nulls, new syntax for `match` and conditional givens, and more</a></div><div><a href="../../../blog/2019/11/04/20th-dotty-milestone-release.html">Announcing Dotty 0.20.0-RC1 – `with` starting indentation blocks, inline given specializations and more</a></div><div><a href="../../../blog/2019/09/23/19th-dotty-milestone-release.html">Announcing Dotty 0.19.0-RC1 – further refinements of the syntax and the migration to 2.13.1 standard library</a></div><div><a href="../../../blog/2019/08/30/18th-dotty-milestone-release.html">Announcing Dotty 0.18.1-RC1 – switch to the 2.13 standard library, indentation-based syntax and other experiments</a></div><div><a href="../../../blog/2019/07/25/17th-dotty-milestone-release.html">Announcing Dotty 0.17.0-RC1 – new implicit scoping rules and more</a></div><div><a href="../../../blog/2019/06/11/16th-dotty-milestone-release.html">Announcing Dotty 0.16.0-RC3 – the Scala Days 2019 Release</a></div><div><a href="../../../blog/2019/05/23/15th-dotty-milestone-release.html">Announcing Dotty 0.15.0-RC1 – the fully bootstrapped compiler</a></div><div><a href="../../../blog/2019/04/15/14th-dotty-milestone-release.html">Announcing Dotty 0.14.0-RC1 with export, immutable arrays, creator applications and more</a></div><div><a href="../../../blog/2019/03/05/13th-dotty-milestone-release.html">Announcing Dotty 0.13.0-RC1 with Spark support, top level definitions and redesigned implicits</a></div><div><a href="../../../blog/2019/01/21/12th-dotty-milestone-release.html">Announcing Dotty 0.12.0-RC1</a></div><div><a href="../../../blog/2018/11/30/11th-dotty-milestone-release.html">Announcing Dotty 0.11.0-RC1</a></div><div><a href="../../../blog/2018/10/10/10th-dotty-milestone-release.html">Announcing Dotty 0.10.0-RC1</a></div><div><a href="../../../blog/2018/07/06/ninth-dotty-milestone-release.html">Announcing Dotty 0.9.0-RC1</a></div><div><a href="../../../blog/2018/04/27/eighth-dotty-milestone-release.html">Announcing Dotty 0.7.0 and 0.8.0-RC1</a></div><div><a href="../../../blog/2018/03/05/seventh-dotty-milestone-release.html">Announcing Dotty 0.6.0 and 0.7.0-RC1</a></div><div><a href="../../../blog/2017/12/01/fifth-dotty-milestone-release.html">Announcing Dotty 0.5.0-RC1</a></div><div><a href="../../../blog/2017/10/16/fourth-dotty-milestone-release.html">Announcing Dotty 0.4.0-RC1</a></div><div><a href="../../../blog/2017/09/07/third-dotty-milestone-release.html">Announcing Dotty 0.3.0-RC2</a></div><div><a href="../../../blog/2017/07/12/second-dotty-milestone-release.html">Announcing Dotty 0.2.0-RC1, with new optimizations, improved stability and IDE support</a></div><div><a href="../../../blog/2017/05/31/first-dotty-milestone-release.html">Announcing Dotty 0.1.2-RC1, a major step towards Scala 3</a></div><div><a href="../../../blog/2016/12/05/implicit-function-types.html">Implicit Function Types</a></div><div><a href="../../../blog/2016/05/05/multiversal-equality.html">Multiversal Equality for Scala</a></div><div><a href="../../../blog/2016/02/17/scaling-dot-soundness.html">Scaling DOT to Scala - Soundness</a></div><div><a href="../../../blog/2016/02/03/essence-of-scala.html">The Essence of Scala</a></div><div><a href="../../../blog/2016/01/02/new-year-resolutions.html">New Year Resolutions</a></div><div><a href="../../../blog/2015/10/23/dotty-compiler-bootstraps.html">We got liftoff!</a></div></div><div><a href="../../Usage/index.html">Usage</a><span></span><div><a href="../../usage/getting-started.html">Getting Started: Users</a></div><div><a href="../../usage/sbt-projects.html">Using Dotty with sbt</a></div><div><a href="../../usage/ide-support.html">IDE support for Dotty</a></div><div><a href="../../usage/worksheet-mode.html">Worksheet mode with Dotty IDE</a></div><div><a href="../../usage/language-versions.html">Language Versions</a></div><div><a href="../../usage/cbt-projects.html">Using Dotty with cbt</a></div><div><a href="../../usage/scala3doc/index.html">Scala3doc</a><span></span><div><a href="../../usage/scala3doc/blog.html">Built-in blog</a></div><div><a href="../../usage/scala3doc/specificTags.html">Scala3doc-specific Tags and Features</a></div><div><a href="../../usage/scala3doc/staticSite.html">Static documentation</a></div><div><a href="../../usage/scala3doc/docComments.html">API Documentation</a></div></div><div><a href="../../usage/dottydoc.html">Dottydoc [Legacy]</a></div></div><div class="expanded"><a href="../../Reference/index.html">Reference</a><span></span><div><a href="../overview.html">Overview</a></div><div><a href="../../New Types/index.html">New Types</a><span></span><div><a href="../new-types/intersection-types.html">Intersection Types</a></div><div><a href="../new-types/union-types.html">Union Types</a></div><div><a href="../new-types/type-lambdas.html">Type Lambdas</a></div><div><a href="../new-types/match-types.html">Match Types</a></div><div><a href="../new-types/dependent-function-types.html">Dependent Function Types</a></div><div><a href="../new-types/polymorphic-function-types.html">Polymorphic Function Types</a></div></div><div><a href="../../Enums/index.html">Enums</a><span></span><div><a href="../enums/enums.html">Enumerations</a></div><div><a href="../enums/adts.html">Algebraic Data Types</a></div><div><a href="../enums/desugarEnums.html">Translation of Enums and ADTs</a></div></div><div class="expanded"><a href="../../Contextual Abstractions/index.html">Contextual Abstractions</a><span></span><div><a href="motivation.html">Overview</a></div><div><a href="givens.html">Given Instances</a></div><div><a href="using-clauses.html">Using Clauses</a></div><div><a href="context-bounds.html">Context Bounds</a></div><div><a href="given-imports.html">Importing Givens</a></div><div><a href="extension-methods.html">Extension Methods</a></div><div><a href="type-classes.html">Implementing Type classes</a></div><div><a href="" class="selected expanded">Type Class Derivation</a></div><div><a href="multiversal-equality.html">Multiversal Equality</a></div><div><a href="context-functions.html">Context Functions</a></div><div><a href="conversions.html">Implicit Conversions</a></div><div><a href="by-name-context-parameters.html">By-Name Context Parameters</a></div><div><a href="relationship-implicits.html">Relationship with Scala 2 Implicits</a></div></div><div><a href="../../Metaprogramming/index.html">Metaprogramming</a><span></span><div><a href="../metaprogramming/toc.html">Overview</a></div><div><a href="../metaprogramming/inline.html">Inline</a></div><div><a href="../metaprogramming/macros.html">Macros</a></div><div><a href="../metaprogramming/staging.html">Multi-Stage Programming</a></div><div><a href="../metaprogramming/tasty-reflect.html">TASTy Reflect</a></div><div><a href="../metaprogramming/tasty-inspect.html">TASTy Inspection</a></div></div><div><a href="../../Other New Features/index.html">Other New Features</a><span></span><div><a href="../other-new-features/trait-parameters.html">Trait Parameters</a></div><div><a href="../other-new-features/transparent-traits.html">Transparent Traits</a></div><div><a href="../other-new-features/creator-applications.html">Universal Apply Methods</a></div><div><a href="../other-new-features/export.html">Export Clauses</a></div><div><a href="../other-new-features/opaques.html">Opaque Type Aliases</a></div><div><a href="../other-new-features/open-classes.html">Open Classes</a></div><div><a href="../other-new-features/parameter-untupling.html">Parameter Untupling</a></div><div><a href="../other-new-features/kind-polymorphism.html">Kind Polymorphism</a></div><div><a href="../other-new-features/matchable.html">The Matchable Trait</a></div><div><a href="../other-new-features/threadUnsafe-annotation.html">The @threadUnsafe annotation</a></div><div><a href="../other-new-features/targetName.html">The @targetName annotation</a></div><div><a href="../other-new-features/control-syntax.html">New Control Syntax</a></div><div><a href="../other-new-features/indentation.html">Optional Braces</a></div><div><a href="../other-new-features/explicit-nulls.html">Explicit Nulls</a></div><div><a href="../other-new-features/safe-initialization.html">Safe Initialization</a></div></div><div><a href="../../Other Changed Features/index.html">Other Changed Features</a><span></span><div><a href="../changed-features/numeric-literals.html">Numeric Literals</a></div><div><a href="../changed-features/structural-types.html">Programmatic Structural Types</a></div><div><a href="../changed-features/operators.html">Rules for Operators</a></div><div><a href="../changed-features/wildcards.html">Wildcard Arguments in Types</a></div><div><a href="../changed-features/type-checking.html">Changes in Type Checking</a></div><div><a href="../changed-features/type-inference.html">Changes in Type Inference</a></div><div><a href="../changed-features/implicit-resolution.html">Changes in Implicit Resolution</a></div><div><a href="../changed-features/implicit-conversions.html">Implicit Conversions</a></div><div><a href="../changed-features/overload-resolution.html">Changes in Overload Resolution</a></div><div><a href="../changed-features/match-syntax.html">Match Expressions</a></div><div><a href="../changed-features/vararg-patterns.html">Vararg Patterns</a></div><div><a href="../changed-features/pattern-bindings.html">Pattern Bindings</a></div><div><a href="../changed-features/pattern-matching.html">Option-less pattern matching</a></div><div><a href="../changed-features/eta-expansion.html">Automatic Eta Expansion</a></div><div><a href="../changed-features/compiler-plugins.html">Changes in Compiler Plugins</a></div><div><a href="../changed-features/lazy-vals-init.html">Lazy Vals initialization</a></div><div><a href="../changed-features/main-functions.html">Main Methods</a></div></div><div><a href="../../Dropped Features/index.html">Dropped Features</a><span></span><div><a href="../dropped-features/delayed-init.html">Dropped: Delayedinit</a></div><div><a href="../dropped-features/macros.html">Dropped: Scala 2 Macros</a></div><div><a href="../dropped-features/existential-types.html">Dropped: Existential Types</a></div><div><a href="../dropped-features/type-projection.html">Dropped: General Type Projection</a></div><div><a href="../dropped-features/do-while.html">Dropped: Do-While</a></div><div><a href="../dropped-features/procedure-syntax.html">Dropped: Procedure Syntax</a></div><div><a href="../dropped-features/package-objects.html">Dropped: Package Objects</a></div><div><a href="../dropped-features/early-initializers.html">Dropped: Early Initializers</a></div><div><a href="../dropped-features/class-shadowing.html">Dropped: Class Shadowing</a></div><div><a href="../dropped-features/limit22.html">Dropped: Limit 22</a></div><div><a href="../dropped-features/xml.html">Dropped: XML Literals</a></div><div><a href="../dropped-features/symlits.html">Dropped: Symbol Literals</a></div><div><a href="../dropped-features/auto-apply.html">Dropped: Auto-Application</a></div><div><a href="../dropped-features/weak-conformance.html">Dropped: Weak Conformance</a></div><div><a href="../dropped-features/nonlocal-returns.html">Deprecated: Nonlocal Returns</a></div><div><a href="../dropped-features/this-qualifier.html">Dropped: private[this] and protected[this]</a></div></div><div><a href="../syntax.html">Scala 3 Syntax Summary</a></div></div><div><a href="../../Contributing/index.html">Contributing</a><span></span><div><a href="../../contributing/contribute-knowledge.html">Contributing Knowledge</a></div><div><a href="../../contributing/getting-started.html">Getting Started</a></div><div><a href="../../contributing/workflow.html">Workflow</a></div><div><a href="../../contributing/testing.html">Testing in Dotty</a></div><div><a href="../../contributing/debugging.html">Debugging Techniques</a></div><div><a href="../../IDEs and Tools/index.html">IDEs and Tools</a><span></span><div><a href="../../contributing/tools/mill.html">Basic Operations with Mill</a></div><div><a href="../../contributing/tools/scalafix.html">Working with Scalafix</a></div></div><div><a href="../../Procedures/index.html">Procedures</a><span></span><div><a href="../../contributing/procedures/release.html">Release Procedure</a></div><div><a href="../../contributing/procedures/vulpix.html">Test Vulpix Framework</a></div></div></div><div><a href="../../Internals/index.html">Internals</a><span></span><div><a href="../../internals/backend.html">Backend Internals</a></div><div><a href="../../internals/classpaths.html">Classpaths</a></div><div><a href="../../internals/core-data-structures.html">Core Data Structures</a></div><div><a href="../../internals/contexts.html">Contexts</a></div><div><a href="../../internals/dotc-scalac.html">Differences between Scalac and Dotty</a></div><div><a href="../../internals/higher-kinded-v2.html">Higher-Kinded Types in Dotty</a></div><div><a href="../../internals/overall-structure.html">Dotty Overall Structure</a></div><div><a href="../../internals/periods.html">Dotc&apos;s concept of time</a></div><div><a href="../../internals/syntax.html">Scala 3 Syntax Summary</a></div><div><a href="../../internals/type-system.html">Type System</a></div><div><a href="../../internals/dotty-internals-1-notes.html">Dotty Internals 1: Trees &amp; Symbols (Meeting Notes)</a></div><div><a href="../../internals/debug-macros.html">Debug Macros</a></div></div><div><a href="../../Resources/index.html">Resources</a><span></span><div><a href="../../resources/talks.html">Talks</a></div></div><div><a href="../../../api/index.html">API</a><span></span><div><a href="../../../api/dotty/tools/tasty.html">dotty.tools.tasty</a></div><div><a href="../../../api/dotty/tools/tasty/util.html">dotty.tools.tasty.util</a></div><div><a href="../../../api/scala.html">scala</a></div><div><a href="../../../api/scala/annotation.html">scala.annotation</a></div><div><a href="../../../api/scala/annotation/meta.html">scala.annotation.meta</a></div><div><a href="../../../api/scala/annotation/unchecked.html">scala.annotation.unchecked</a></div><div><a href="../../../api/scala/beans.html">scala.beans</a></div><div><a href="../../../api/scala/collection.html">scala.collection</a></div><div><a href="../../../api/scala/collection/concurrent.html">scala.collection.concurrent</a></div><div><a href="../../../api/scala/collection/convert.html">scala.collection.convert</a></div><div><a href="../../../api/scala/collection/generic.html">scala.collection.generic</a></div><div><a href="../../../api/scala/collection/immutable.html">scala.collection.immutable</a></div><div><a href="../../../api/scala/collection/mutable.html">scala.collection.mutable</a></div><div><a href="../../../api/scala/compat.html">scala.compat</a></div><div><a href="../../../api/scala/compiletime.html">scala.compiletime</a></div><div><a href="../../../api/scala/compiletime/ops.html">scala.compiletime.ops</a></div><div><a href="../../../api/scala/compiletime/testing.html">scala.compiletime.testing</a></div><div><a href="../../../api/scala/concurrent.html">scala.concurrent</a></div><div><a href="../../../api/scala/concurrent/duration.html">scala.concurrent.duration</a></div><div><a href="../../../api/scala/deriving.html">scala.deriving</a></div><div><a href="../../../api/scala/io.html">scala.io</a></div><div><a href="../../../api/scala/jdk.html">scala.jdk</a></div><div><a href="../../../api/scala/jdk/javaapi.html">scala.jdk.javaapi</a></div><div><a href="../../../api/scala/math.html">scala.math</a></div><div><a href="../../../api/scala/quoted.html">scala.quoted</a></div><div><a href="../../../api/scala/quoted/runtime.html">scala.quoted.runtime</a></div><div><a href="../../../api/scala/ref.html">scala.ref</a></div><div><a href="../../../api/scala/reflect.html">scala.reflect</a></div><div><a href="../../../api/scala/reflect/macros.html">scala.reflect.macros</a></div><div><a href="../../../api/scala/runtime.html">scala.runtime</a></div><div><a href="../../../api/scala/runtime/java8.html">scala.runtime.java8</a></div><div><a href="../../../api/scala/sys.html">scala.sys</a></div><div><a href="../../../api/scala/sys/process.html">scala.sys.process</a></div><div><a href="../../../api/scala/util.html">scala.util</a></div><div><a href="../../../api/scala/util/control.html">scala.util.control</a></div><div><a href="../../../api/scala/util/hashing.html">scala.util.hashing</a></div><div><a href="../../../api/scala/util/matching.html">scala.util.matching</a></div></div></div></nav></div><div id="main"><div id="leftToggler"><span class="icon-toggler"></span></div><div id="searchBar"></div><main>
  <div id="content" pageIds="docs.reference.contextual.derivation.md////PointingToDeclaration//2049806133">
    <div class="breadcrumbs"><a href="../../index.html">Scala 3</a>/<a href="../../Reference/index.html">Reference</a>/<a href="../../Contextual Abstractions/index.html">Contextual Abstractions</a>/<a href="">Type Class Derivation</a></div>
<html>
 <head>
  <link rel="dns-prefetch" href="//fonts.googleapis.com"> 
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"> 
 </head>
 <body>
  <div id="content-wrapper"> 
   <main class="container"> 
    <header> 
     <h1>Type Class Derivation</h1> 
     <div class="byline"> <a href="https://github.com/lampepfl/dotty/edit/master/docs/docs/reference/contextual/derivation.md"> <i class="far fa-edit"></i> Edit this page on GitHub </a> 
     </div> 
    </header> 
    <p>Type class derivation is a way to automatically generate given instances for type classes which satisfy some simple conditions. A type class in this sense is any trait or class with a type parameter determining the type being operated on. Common examples are <code>Eq</code>, <code>Ordering</code>, or <code>Show</code>. For example, given the following <code>Tree</code> algebraic data type (ADT),</p> 
    <pre><code class="language-scala">enum Tree[T] derives Eq, Ordering, Show:
   case Branch(left: Tree[T], right: Tree[T])
   case Leaf(elem: T)
</code></pre> 
    <p>The <code>derives</code> clause generates the following given instances for the <code>Eq</code>, <code>Ordering</code> and <code>Show</code> type classes in the companion object of <code>Tree</code>,</p> 
    <pre><code class="language-scala">given [T: Eq]       : Eq[Tree[T]]    = Eq.derived
given [T: Ordering] : Ordering[Tree] = Ordering.derived
given [T: Show]     : Show[Tree]     = Show.derived
</code></pre> 
    <p>We say that <code>Tree</code> is the <em>deriving type</em> and that the <code>Eq</code>, <code>Ordering</code> and <code>Show</code> instances are <em>derived instances</em>.</p> 
    <h3><a href="#types-supporting-derives-clauses" id="types-supporting-derives-clauses" class="anchor"></a>Types supporting <code>derives</code> clauses</h3> 
    <p>All data types can have a <code>derives</code> clause. This document focuses primarily on data types which also have a given instance of the <code>Mirror</code> type class available. Instances of the <code>Mirror</code> type class are generated automatically by the compiler for,</p> 
    <ul> 
     <li>enums and enum cases</li> 
     <li>case classes and case objects</li> 
     <li>sealed classes or traits that have only case classes and case objects as children</li> 
    </ul> 
    <p><code>Mirror</code> type class instances provide information at the type level about the components and labelling of the type. They also provide minimal term level infrastructure to allow higher level libraries to provide comprehensive derivation support.</p> 
    <pre><code class="language-scala">sealed trait Mirror:

   /** the type being mirrored */
   type MirroredType

   /** the type of the elements of the mirrored type */
   type MirroredElemTypes

   /** The mirrored *-type */
   type MirroredMonoType

   /** The name of the type */
   type MirroredLabel &lt;: String

   /** The names of the elements of the type */
   type MirroredElemLabels &lt;: Tuple

object Mirror:

   /** The Mirror for a product type */
   trait Product extends Mirror:

      /** Create a new instance of type `T` with elements
       *  taken from product `p`.
       */
      def fromProduct(p: scala.Product): MirroredMonoType

   trait Sum extends Mirror:

      /** The ordinal number of the case class of `x`.
       *  For enums, `ordinal(x) == x.ordinal`
       */
      def ordinal(x: MirroredMonoType): Int

end Mirror
</code></pre> 
    <p>Product types (i.e. case classes and objects, and enum cases) have mirrors which are subtypes of <code>Mirror.Product</code>. Sum types (i.e. sealed class or traits with product children, and enums) have mirrors which are subtypes of <code>Mirror.Sum</code>.</p> 
    <p>For the <code>Tree</code> ADT from above the following <code>Mirror</code> instances will be automatically provided by the compiler,</p> 
    <pre><code class="language-scala">// Mirror for Tree
new Mirror.Sum:
   type MirroredType = Tree
   type MirroredElemTypes[T] = (Branch[T], Leaf[T])
   type MirroredMonoType = Tree[_]
   type MirroredLabels = "Tree"
   type MirroredElemLabels = ("Branch", "Leaf")

   def ordinal(x: MirroredMonoType): Int = x match
      case _: Branch[_] =&gt; 0
      case _: Leaf[_] =&gt; 1

// Mirror for Branch
new Mirror.Product:
   type MirroredType = Branch
   type MirroredElemTypes[T] = (Tree[T], Tree[T])
   type MirroredMonoType = Branch[_]
   type MirroredLabels = "Branch"
   type MirroredElemLabels = ("left", "right")

   def fromProduct(p: Product): MirroredMonoType =
      new Branch(...)

// Mirror for Leaf
new Mirror.Product:
   type MirroredType = Leaf
   type MirroredElemTypes[T] = Tuple1[T]
   type MirroredMonoType = Leaf[_]
   type MirroredLabels = "Leaf"
   type MirroredElemLabels = Tuple1["elem"]

   def fromProduct(p: Product): MirroredMonoType =
      new Leaf(...)
</code></pre> 
    <p>Note the following properties of <code>Mirror</code> types,</p> 
    <ul> 
     <li>Properties are encoded using types rather than terms. This means that they have no runtime footprint unless used and also that they are a compile time feature for use with Scala 3's metaprogramming facilities.</li> 
     <li>The kinds of <code>MirroredType</code> and <code>MirroredElemTypes</code> match the kind of the data type the mirror is an instance for. This allows <code>Mirror</code>s to support ADTs of all kinds.</li> 
     <li>There is no distinct representation type for sums or products (ie. there is no <code>HList</code> or <code>Coproduct</code> type as in Scala 2 versions of Shapeless). Instead the collection of child types of a data type is represented by an ordinary, possibly parameterized, tuple type. Scala 3's metaprogramming facilities can be used to work with these tuple types as-is, and higher level libraries can be built on top of them.</li> 
     <li>For both product and sum types, the elements of <code>MirroredElemTypes</code> are arranged in definition order (i.e. <code>Branch[T]</code> precedes <code>Leaf[T]</code> in <code>MirroredElemTypes</code> for <code>Tree</code> because <code>Branch</code> is defined before <code>Leaf</code> in the source file). This means that <code>Mirror.Sum</code> differs in this respect from Shapeless's generic representation for ADTs in Scala 2, where the constructors are ordered alphabetically by name.</li> 
     <li>The methods <code>ordinal</code> and <code>fromProduct</code> are defined in terms of <code>MirroredMonoType</code> which is the type of kind-<code>*</code> which is obtained from <code>MirroredType</code> by wildcarding its type parameters.</li> 
    </ul> 
    <h3><a href="#type-classes-supporting-automatic-deriving" id="type-classes-supporting-automatic-deriving" class="anchor"></a>Type classes supporting automatic deriving</h3> 
    <p>A trait or class can appear in a <code>derives</code> clause if its companion object defines a method named <code>derived</code>. The signature and implementation of a <code>derived</code> method for a type class <code>TC[_]</code> are arbitrary but it is typically of the following form,</p> 
    <pre><code class="language-scala">def derived[T](using Mirror.Of[T]): TC[T] = ...
</code></pre> 
    <p>That is, the <code>derived</code> method takes a context parameter of (some subtype of) type <code>Mirror</code> which defines the shape of the deriving type <code>T</code>, and computes the type class implementation according to that shape. This is all that the provider of an ADT with a <code>derives</code> clause has to know about the derivation of a type class instance.</p> 
    <p>Note that <code>derived</code> methods may have context <code>Mirror</code> parameters indirectly (e.g. by having a context argument which in turn has a context <code>Mirror</code> parameter, or not at all (e.g. they might use some completely different user-provided mechanism, for instance using Scala 3 macros or runtime reflection). We expect that (direct or indirect) <code>Mirror</code> based implementations will be the most common and that is what this document emphasises.</p> 
    <p>Type class authors will most likely use higher level derivation or generic programming libraries to implement <code>derived</code> methods. An example of how a <code>derived</code> method might be implemented using <em>only</em> the low level facilities described above and Scala 3's general metaprogramming features is provided below. It is not anticipated that type class authors would normally implement a <code>derived</code> method in this way, however this walkthrough can be taken as a guide for authors of the higher level derivation libraries that we expect typical type class authors will use (for a fully worked out example of such a library, see <a href="https://github.com/milessabin/shapeless/tree/shapeless-3">Shapeless 3</a>).</p> 
    <h4><a href="#how-to-write-a-type-class-derived-method-using-low-level-mechanisms" id="how-to-write-a-type-class-derived-method-using-low-level-mechanisms" class="anchor"></a>How to write a type class <code>derived</code> method using low level mechanisms</h4> 
    <p>The low-level method we will use to implement a type class <code>derived</code> method in this example exploits three new type-level constructs in Scala 3: inline methods, inline matches, and implicit searches via <code>summonInline</code> or <code>summonFrom</code>. Given this definition of the <code>Eq</code> type class,</p> 
    <pre><code class="language-scala">trait Eq[T]:
   def eqv(x: T, y: T): Boolean
</code></pre> 
    <p>we need to implement a method <code>Eq.derived</code> on the companion object of <code>Eq</code> that produces a given instance for <code>Eq[T]</code> given a <code>Mirror[T]</code>. Here is a possible implementation,</p> 
    <pre><code class="language-scala">inline given derived[T](using m: Mirror.Of[T]): Eq[T] =
   val elemInstances = summonAll[m.MirroredElemTypes]           // (1)
   inline m match                                               // (2)
      case s: Mirror.SumOf[T]     =&gt; eqSum(s, elemInstances)
      case p: Mirror.ProductOf[T] =&gt; eqProduct(p, elemInstances)
</code></pre> 
    <p>Note that <code>derived</code> is defined as an <code>inline</code> given. This means that the method will be expanded at call sites (for instance the compiler generated instance definitions in the companion objects of ADTs which have a <code>derived Eq</code> clause), and also that it can be used recursively if necessary, to compute instances for children.</p> 
    <p>The body of this method (1) first materializes the <code>Eq</code> instances for all the child types of type the instance is being derived for. This is either all the branches of a sum type or all the fields of a product type. The implementation of <code>summonAll</code> is <code>inline</code> and uses Scala 3's <code>summonInline</code> construct to collect the instances as a <code>List</code>,</p> 
    <pre><code class="language-scala">inline def summonAll[T &lt;: Tuple]: List[Eq[_]] =
   inline erasedValue[T] match
      case _: EmptyTuple =&gt; Nil
      case _: (t *: ts) =&gt; summonInline[Eq[t]] :: summonAll[ts]
</code></pre> 
    <p>with the instances for children in hand the <code>derived</code> method uses an <code>inline match</code> to dispatch to methods which can construct instances for either sums or products (2). Note that because <code>derived</code> is <code>inline</code> the match will be resolved at compile-time and only the left-hand side of the matching case will be inlined into the generated code with types refined as revealed by the match.</p> 
    <p>In the sum case, <code>eqSum</code>, we use the runtime <code>ordinal</code> values of the arguments to <code>eqv</code> to first check if the two values are of the same subtype of the ADT (3) and then, if they are, to further test for equality based on the <code>Eq</code> instance for the appropriate ADT subtype using the auxiliary method <code>check</code> (4).</p> 
    <pre><code class="language-scala">def eqSum[T](s: Mirror.SumOf[T], elems: List[Eq[_]]): Eq[T] =
   new Eq[T]:
      def eqv(x: T, y: T): Boolean =
         val ordx = s.ordinal(x)                            // (3)
         (s.ordinal(y) == ordx) &amp;&amp; check(elems(ordx))(x, y) // (4)
</code></pre> 
    <p>In the product case, <code>eqProduct</code> we test the runtime values of the arguments to <code>eqv</code> for equality as products based on the <code>Eq</code> instances for the fields of the data type (5),</p> 
    <pre><code class="language-scala">def eqProduct[T](p: Mirror.ProductOf[T], elems: List[Eq[_]]): Eq[T] =
   new Eq[T]:
      def eqv(x: T, y: T): Boolean =
         iterator(x).zip(iterator(y)).zip(elems.iterator).forall {  // (5)
            case ((x, y), elem) =&gt; check(elem)(x, y)
         }
</code></pre> 
    <p>Pulling this all together we have the following complete implementation,</p> 
    <pre><code class="language-scala">import scala.deriving._
import scala.compiletime.{erasedValue, summonInline}

inline def summonAll[T &lt;: Tuple]: List[Eq[_]] =
   inline erasedValue[T] match
      case _: EmptyTuple =&gt; Nil
      case _: (t *: ts) =&gt; summonInline[Eq[t]] :: summonAll[ts]

trait Eq[T]:
   def eqv(x: T, y: T): Boolean

object Eq:
   given Eq[Int] with
      def eqv(x: Int, y: Int) = x == y

   def check(elem: Eq[_])(x: Any, y: Any): Boolean =
      elem.asInstanceOf[Eq[Any]].eqv(x, y)

   def iterator[T](p: T) = p.asInstanceOf[Product].productIterator

   def eqSum[T](s: Mirror.SumOf[T], elems: =&gt; List[Eq[_]]): Eq[T] =
      new Eq[T]:
         def eqv(x: T, y: T): Boolean =
            val ordx = s.ordinal(x)
            (s.ordinal(y) == ordx) &amp;&amp; check(elems(ordx))(x, y)

   def eqProduct[T](p: Mirror.ProductOf[T], elems: =&gt; List[Eq[_]]): Eq[T] =
      new Eq[T]:
         def eqv(x: T, y: T): Boolean =
            iterator(x).zip(iterator(y)).zip(elems.iterator).forall {
               case ((x, y), elem) =&gt; check(elem)(x, y)
            }

   inline given derived[T](using m: Mirror.Of[T]): Eq[T] =
      lazy val elemInstances = summonAll[m.MirroredElemTypes]
      inline m match
         case s: Mirror.SumOf[T]     =&gt; eqSum(s, elemInstances)
         case p: Mirror.ProductOf[T] =&gt; eqProduct(p, elemInstances)
end Eq
</code></pre> 
    <p>we can test this relative to a simple ADT like so,</p> 
    <pre><code class="language-scala">enum Opt[+T] derives Eq:
   case Sm(t: T)
   case Nn

@main def test =
   import Opt._
   val eqoi = summon[Eq[Opt[Int]]]
   assert(eqoi.eqv(Sm(23), Sm(23)))
   assert(!eqoi.eqv(Sm(23), Sm(13)))
   assert(!eqoi.eqv(Sm(23), Nn))
</code></pre> 
    <p>In this case the code that is generated by the inline expansion for the derived <code>Eq</code> instance for <code>Opt</code> looks like the following, after a little polishing,</p> 
    <pre><code class="language-scala">given derived$Eq[T](using eqT: Eq[T]): Eq[Opt[T]] =
   eqSum(
      summon[Mirror[Opt[T]]],
      List(
         eqProduct(summon[Mirror[Sm[T]]], List(summon[Eq[T]])),
         eqProduct(summon[Mirror[Nn.type]], Nil)
      )
   )
</code></pre> 
    <p>Alternative approaches can be taken to the way that <code>derived</code> methods can be defined. For example, more aggressively inlined variants using Scala 3 macros, whilst being more involved for type class authors to write than the example above, can produce code for type classes like <code>Eq</code> which eliminate all the abstraction artefacts (eg. the <code>Lists</code> of child instances in the above) and generate code which is indistinguishable from what a programmer might write by hand. As a third example, using a higher level library such as Shapeless the type class author could define an equivalent <code>derived</code> method as,</p> 
    <pre><code class="language-scala">given eqSum[A](using inst: =&gt; K0.CoproductInstances[Eq, A]): Eq[A] with
   def eqv(x: A, y: A): Boolean = inst.fold2(x, y)(false)(
      [t] =&gt; (eqt: Eq[t], t0: t, t1: t) =&gt; eqt.eqv(t0, t1)

given eqProduct[A](using inst: K0.ProductInstances[Eq, A]): Eq[A] with
   def eqv(x: A, y: A): Boolean = inst.foldLeft2(x, y)(true: Boolean)(
      [t] =&gt; (acc: Boolean, eqt: Eq[t], t0: t, t1: t) =&gt;
         Complete(!eqt.eqv(t0, t1))(false)(true)
   )

inline def derived[A](using gen: K0.Generic[A]) as Eq[A] =
   gen.derive(eqSum, eqProduct)
</code></pre> 
    <p>The framework described here enables all three of these approaches without mandating any of them.</p> 
    <p>For a brief discussion on how to use macros to write a type class <code>derived</code> method please read more at <a href="derivation-macro.html">How to write a type class <code>derived</code> method using macros</a>.</p> 
    <h3><a href="#deriving-instances-elsewhere" id="deriving-instances-elsewhere" class="anchor"></a>Deriving instances elsewhere</h3> 
    <p>Sometimes one would like to derive a type class instance for an ADT after the ADT is defined, without being able to change the code of the ADT itself. To do this, simply define an instance using the <code>derived</code> method of the type class as right-hand side. E.g, to implement <code>Ordering</code> for <code>Option</code> define,</p> 
    <pre><code class="language-scala">given [T: Ordering]: Ordering[Option[T]] = Ordering.derived
</code></pre> 
    <p>Assuming the <code>Ordering.derived</code> method has a context parameter of type <code>Mirror[T]</code> it will be satisfied by the compiler generated <code>Mirror</code> instance for <code>Option</code> and the derivation of the instance will be expanded on the right hand side of this definition in the same way as an instance defined in ADT companion objects.</p> 
    <h3><a href="#syntax" id="syntax" class="anchor"></a>Syntax</h3> 
    <pre><code>Template          ::=  InheritClauses [TemplateBody]
EnumDef           ::=  id ClassConstr InheritClauses EnumBody
InheritClauses    ::=  [‘extends’ ConstrApps] [‘derives’ QualId {‘,’ QualId}]
ConstrApps        ::=  ConstrApp {‘with’ ConstrApp}
                    |  ConstrApp {‘,’ ConstrApp}
</code></pre> 
    <p><strong>Note:</strong> To align <code>extends</code> clauses and <code>derives</code> clauses, Scala 3 also allows multiple extended types to be separated by commas. So the following is now legal:</p> 
    <pre><code class="language-scala">class A extends B, C { ... }
</code></pre> 
    <p>It is equivalent to the old form</p> 
    <pre><code class="language-scala">class A extends B with C { ... }
</code></pre> 
    <h3><a href="#discussion" id="discussion" class="anchor"></a>Discussion</h3> 
    <p>This type class derivation framework is intentionally very small and low-level. There are essentially two pieces of infrastructure in compiler-generated <code>Mirror</code> instances,</p> 
    <ul> 
     <li>type members encoding properties of the mirrored types.</li> 
     <li>a minimal value level mechanism for working generically with terms of the mirrored types.</li> 
    </ul> 
    <p>The <code>Mirror</code> infrastructure can be seen as an extension of the existing <code>Product</code> infrastructure for case classes: typically <code>Mirror</code> types will be implemented by the ADTs companion object, hence the type members and the <code>ordinal</code> or <code>fromProduct</code> methods will be members of that object. The primary motivation for this design decision, and the decision to encode properties via types rather than terms was to keep the bytecode and runtime footprint of the feature small enough to make it possible to provide <code>Mirror</code> instances <em>unconditionally</em>.</p> 
    <p>Whilst <code>Mirrors</code> encode properties precisely via type members, the value level <code>ordinal</code> and <code>fromProduct</code> are somewhat weakly typed (because they are defined in terms of <code>MirroredMonoType</code>) just like the members of <code>Product</code>. This means that code for generic type classes has to ensure that type exploration and value selection proceed in lockstep and it has to assert this conformance in some places using casts. If generic type classes are correctly written these casts will never fail.</p> 
    <p>As mentioned, however, the compiler-provided mechanism is intentionally very low level and it is anticipated that higher level type class derivation and generic programming libraries will build on this and Scala 3's other metaprogramming facilities to hide these low-level details from type class authors and general users. Type class derivation in the style of both Shapeless and Magnolia are possible (a prototype of Shapeless 3, which combines aspects of both Shapeless 2 and Magnolia has been developed alongside this language feature) as is a more aggressively inlined style, supported by Scala 3's new quote/splice macro and inlining facilities.</p> 
   </main> 
  </div> 
  <script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'lampepfl/dotty'
  };
</script> 
  <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
 </body>
</html>  </div>
</main><footer><span class="go-to-top-icon"><a href="#container"><span class="icon-vertical_align_top"></span>&nbsp;Back to top</a></span>Generated by&nbsp;<a href="https://github.com/lampepfl/dotty/tree/master/scala3doc"><img src="../../../images/scala3doc_logo.svg" alt="Scala3doc" class="scala3doc_logo"></img></a></footer></div></div><script type="text/javascript" src="../../../scripts/pages.js"></script><script type="text/javascript" src="../../../scripts/main.js"></script></body></html>
